This is my_collection.html:
<!DOCTYPE html>

<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>My Collection - HatakeSocial</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="css/style.css" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: 'class',
            plugins: [
                function ({ addVariant }) {
                    addVariant('has-[:checked]', '&:has(:checked)')
                }
            ]
        };
    </script>
<link href="/manifest.json" rel="manifest"/>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 font-sans overflow-hidden">
<div class="flex h-screen">
<div class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" id="sidebar-overlay"></div>
<aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-50 lg:relative lg:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out" id="sidebar">
<div class="h-28 flex items-center justify-center border-b border-gray-200 dark:border-gray-700 px-4">
<a class="flex flex-col items-center space-y-1" href="app.html">
<img alt="HatakeSocial Logo" class="h-16" src="https://i.imgur.com/B06rBhI.png"/>
<span class="font-bold text-lg text-blue-600 dark:text-blue-400">HatakeSocial</span>
</a>
</div>
<nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="app.html">
<i class="fas fa-home w-6 text-center">
</i>
<span class="ml-3">
       Feed
      </span>
</a>
<a class="flex items-center px-4 py-2 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-md" href="messages.html">
<i class="fas fa-comments w-6 text-center">
</i>
<span class="ml-3">
       Messages
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="community.html">
<i class="fas fa-users w-6 text-center">
</i>
<span class="ml-3">
       Community
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="articles.html?type=tcg">
<i class="fas fa-newspaper w-6 text-center">
</i>
<span class="ml-3">
       TCG Articles
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="articles.html?type=blog">
<i class="fas fa-blog w-6 text-center">
</i>
<span class="ml-3">
       Hatake Blog
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="events.html">
<i class="fas fa-calendar-alt w-6 text-center">
</i>
<span class="ml-3">
       Events
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="my_collection.html">
<i class="fas fa-layer-group w-6 text-center">
</i>
<span class="ml-3">
       My Collection
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="deck.html">
<i class="fas fa-book-open w-6 text-center">
</i>
<span class="ml-3">
       Deck Builder
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="shop.html">
<i class="fas fa-shopping-cart w-6 text-center">
</i>
<span class="ml-3">
       Shop
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="marketplace.html">
<i class="fas fa-store w-6 text-center">
</i>
<span class="ml-3">
       Marketplace
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="trades.html">
<i class="fas fa-exchange-alt w-6 text-center">
</i>
<span class="ml-3">
       Trades
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="profile.html">
<i class="fas fa-user w-6 text-center">
</i>
<span class="ml-3">
       Profile
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="settings.html">
<i class="fas fa-cog w-6 text-center">
</i>
<span class="ml-3">
       Settings
      </span>
</a>
<a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="about.html">
<i class="fas fa-info-circle w-6 text-center">
</i>
<span class="ml-3">
       About Us
      </span>
</a>
</nav> <div class="px-4 py-4 border-t border-gray-200 dark:border-gray-700">
<div id="auth-container-sidebar"></div>
</div>
</aside>
<div class="flex-1 flex flex-col overflow-hidden">
<header class="h-28 flex items-center justify-between px-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
<div class="flex items-center">
<button class="lg:hidden mr-4 text-gray-600 dark:text-gray-300" id="sidebar-toggle">
<i class="fas fa-bars text-xl">
</i>
</button>
<div class="relative">
<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
</i>
<input class="w-full md:w-96 pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" id="main-search-bar" placeholder="Search for cards, users, or articles..." type="text"/>
</div>
</div>
<div class="flex items-center space-x-5" id="user-actions">
</div>
</header>
<main class="flex-1 overflow-hidden flex">
<div class="w-full md:w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700 p-6 flex-shrink-0 flex flex-col overflow-y-auto">
<div class="mb-6">
<h3 class="text-lg font-semibold mb-3" id="stats-title">Statistics</h3>
<div class="space-y-2 text-sm">
<div class="flex justify-between"><span id="stats-total-label">Total Cards:</span> <span class="font-mono" id="stats-total-cards">0</span></div>
<div class="flex justify-between"><span id="stats-unique-label">Unique Cards:</span> <span class="font-mono" id="stats-unique-cards">0</span></div>
<div class="flex justify-between"><span id="stats-value-label">Total Value:</span> <span class="font-mono" id="stats-total-value">$0.00</span></div>
</div>
</div>
<div class="mb-6 flex-1">
<h3 class="text-lg font-semibold mb-3">Filters</h3>
<div class="space-y-4">
<input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" id="filter-name" placeholder="Filter by name..." type="text"/>
<div id="filter-set-container" class="relative"></div>
<div id="filter-rarity-container" class="relative"></div>
<div id="game-specific-filters">
    </div>
<button class="w-full text-left flex items-center p-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" id="clear-filters-btn"><i class="fas fa-times w-6"></i> Clear Filters</button>
</div>
</div>
<div>
<h3 class="text-lg font-semibold mb-3">Actions</h3>
<div class="space-y-2">
<button class="w-full text-left flex items-center p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="add-card-btn"><i class="fas fa-plus w-6"></i> Add Card</button>
<button class="w-full text-left flex items-center p-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" id="bulk-edit-btn"><i class="fas fa-edit w-6"></i> Bulk Edit</button>
<button class="w-full text-left flex items-center p-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" id="csv-import-btn"><i class="fas fa-file-csv w-6"></i> Import from CSV</button>
</div>
</div>
</div>
<div class="flex-1 flex flex-col overflow-hidden p-6">
<div class="flex-shrink-0 mb-4">
<div class="flex flex-wrap justify-between items-center gap-4">
<div class="flex space-x-1 bg-gray-200 dark:bg-gray-700 p-1 rounded-full text-sm font-semibold">
<button class="tab-button flex-1 px-4 py-2 rounded-full active" data-tab="collection">Collection</button>
<button class="tab-button flex-1 px-4 py-2 rounded-full" data-tab="wishlist">Wishlist</button>
</div>
<div class="flex space-x-1 bg-gray-200 dark:bg-gray-700 p-1 rounded-full text-sm font-semibold" id="tcg-filter-buttons">
<button class="tcg-filter-button flex-1 px-4 py-2 rounded-full active" data-game="all">All</button>
<button class="tcg-filter-button flex-1 px-4 py-2 rounded-full" data-game="mtg">Magic</button>
<button class="tcg-filter-button flex-1 px-4 py-2 rounded-full" data-game="pokemon">Pokémon</button>
</div>
<div class="flex items-center space-x-4">
<div class="flex items-center bg-gray-200 dark:bg-gray-700 rounded-full p-1">
<button class="p-2 rounded-full text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-900 shadow" id="view-toggle-grid"><i class="fas fa-th-large"></i></button>
<button class="p-2 rounded-full text-gray-500 dark:text-gray-400" id="view-toggle-list"><i class="fas fa-list"></i></button>
</div>
</div>
</div>
</div>
<div class="hidden mb-4 p-4 rounded-lg bg-blue-100 dark:bg-blue-900/50 shadow-md flex items-center justify-between gap-4" id="bulk-edit-toolbar">
<div class="flex items-center gap-4">
<p class="text-sm font-semibold text-blue-800 dark:text-blue-200">
<span id="bulk-selected-count">0</span> selected
                        </p>
<button class="btn btn-sm bg-blue-200 text-blue-800 hover:bg-blue-300" id="bulk-select-all-btn">Select All</button>
</div>
<div class="flex items-center space-x-2">
<button class="btn btn-success" id="bulk-list-btn">
<i class="fas fa-tag mr-2"></i>List for Sale
                        </button>
<button class="btn bg-red-500 hover:bg-red-600 text-white" id="bulk-delete-btn">
<i class="fas fa-trash mr-2"></i>Delete Selected
                        </button>
</div>
</div>
<div class="flex-1 overflow-y-auto" id="collection-display">
<div class="flex items-center justify-center h-full text-gray-500"><p>Loading your collection...</p></div>
</div>
</div>
</main>
</div>
</div>
<div class="fixed bottom-5 right-5 z-[1003]" id="toast-container"></div>
<div class="fixed z-[1005] pointer-events-none hidden rounded-xl shadow-lg border-4 border-gray-400" id="card-preview-tooltip" style="width: 260px;">
<img alt="Card Preview" class="w-full rounded-lg" src=""/>
</div>
<div class="fixed inset-0 bg-black bg-opacity-75 hidden items-start justify-center z-[1001] pt-16" id="search-modal">
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="height: 80vh;">
<div class="p-4 border-b dark:border-gray-700 flex items-center">
<div class="relative flex-grow mr-4">
<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
<input class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" id="card-search-input" placeholder="Search for a card..." type="text"/>
</div>
<select class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="game-selector">
<option value="mtg">Magic: The Gathering</option>
<option value="pokemon">Pokémon</option>
</select>
<button class="ml-4 text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="close-search-modal">×</button>
</div>
<div class="p-6 flex-grow overflow-y-auto" id="search-results-container">
<p class="text-center text-gray-500">Search results will appear here.</p>
</div>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1002]" id="card-modal">
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl flex" style="max-height: 90vh;">
<div class="w-1/3 p-6 bg-gray-100 dark:bg-gray-900 rounded-l-lg flex items-center justify-center">
<img class="max-w-full max-h-full rounded-lg object-contain" id="card-modal-image" src="https://placehold.co/300x420?text=Card+Image"/>
</div>
<div class="w-2/3 p-6 flex flex-col">
<form class="flex flex-col h-full" id="card-form">
<input id="card-modal-id" type="hidden"/>
<input id="card-api-id" type="hidden"/>
<div class="flex justify-between items-start">
<div>
<h2 class="text-2xl font-bold" id="card-modal-title">Add New Card</h2>
<p class="text-sm text-gray-500" id="card-modal-subtitle">Details for this version</p>
</div>
<button class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="close-card-modal" type="button">×</button>
</div>
<div class="flex-grow overflow-y-auto pr-2">
<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
<div><label class="block text-sm font-medium" for="card-quantity">Quantity</label><input class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="card-quantity" min="1" type="number" value="1"/></div>
<div><label class="block text-sm font-medium" for="card-condition">Condition</label><select class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="card-condition"><option>Near Mint</option><option>Lightly Played</option><option>Moderately Played</option><option>Heavily Played</option><option>Damaged</option></select></div>
<div><label class="block text-sm font-medium" for="card-language">Language</label><select class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="card-language"><option>English</option><option>Japanese</option><option>French</option><option>German</option><option>Spanish</option><option>Italian</option><option>Portuguese</option><option>Russian</option><option>Korean</option><option>Chinese (Simplified)</option><option>Chinese (Traditional)</option></select></div>
<div><label class="block text-sm font-medium" for="card-purchase-price">Purchase Price ($)</label><input class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="card-purchase-price" placeholder="0.00" step="0.01" type="number"/></div>
</div>
<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
<label class="flex items-center"><input class="mr-2" id="card-is-foil" type="checkbox"/> Foil</label>
<label class="flex items-center"><input class="mr-2" id="card-is-signed" type="checkbox"/> Signed</label>
<label class="flex items-center"><input class="mr-2" id="card-is-altered" type="checkbox"/> Altered</label>
</div>
<div class="mt-4">
<label class="block text-sm font-medium" for="custom-image-upload">Custom Image (optional)</label>
<input accept="image/*" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="custom-image-upload" type="file"/>
</div>
<div class="mt-4">
<label class="flex items-center">
<input class="mr-2" id="list-for-sale-toggle" type="checkbox"/>
                            List for Sale
                        </label>
<div class="hidden mt-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-md" id="list-for-sale-section">
<div class="mb-2">
<span class="text-sm text-gray-600 dark:text-gray-400">Market Price: </span>
<span class="font-semibold" id="market-price-display">$0.00</span>
</div>
<div class="grid grid-cols-2 gap-2">
<div>
<label class="block text-sm font-medium" for="card-sale-percentage">% of Market</label>
<div class="flex items-center">
<input class="flex-1 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="card-sale-percentage" max="500" min="1" type="number" value="100"/>
<span class="ml-1 text-sm">%</span>
</div>
</div>
<div class="flex-1">
<label class="block text-sm font-medium" for="card-sale-price">Or set fixed price ($)</label>
<input class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="card-sale-price" placeholder="0.00" step="0.01" type="number"/>
</div>
</div>
</div>
</div>
<div class="mt-4 border-t pt-2" id="pending-cards-container"></div>
</div>
<div class="mt-auto pt-4 flex justify-end items-center space-x-3 flex-shrink-0">
<button class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" id="add-another-version-btn" type="button">Add This Version</button>
<button class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700" id="save-card-btn" type="submit">Add to Collection</button>
</div>
</form>
</div>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" id="bulk-list-sale-modal">
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold">List <span id="bulk-list-count">0</span> Cards for Sale</h3>
<button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" id="close-bulk-list-sale-modal">
<i class="fas fa-times fa-lg"></i>
</button>
</div>
<form id="bulk-list-form">
<div class="space-y-4">
<p class="text-sm text-gray-600 dark:text-gray-400">Choose how to price the selected cards.</p>
<div class="space-y-2">
<label class="flex items-center p-3 rounded-lg border dark:border-gray-600 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/50">
<input checked="" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="price-option" type="radio" value="percentage"/>
<span class="ml-3 text-sm font-medium">Set Price by % of Market Value</span>
</label>
<label class="flex items-center p-3 rounded-lg border dark:border-gray-600 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/50">
<input class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="price-option" type="radio" value="fixed"/>
<span class="ml-3 text-sm font-medium">Set a Fixed Price for all cards</span>
</label>
<label class="flex items-center p-3 rounded-lg border dark:border-gray-600 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/50">
<input class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="price-option" type="radio" value="individual"/>
<span class="ml-3 text-sm font-medium">Keep Individual Prices (if set)</span>
</label>
</div>
<div id="bulk-price-percentage-group">
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="bulk-price-percentage">Market Value Percentage (%)</label>
<input class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="bulk-price-percentage" name="percentage" placeholder="e.g., 90 for 90%" type="number" value="100"/>
</div>
<div class="hidden" id="bulk-price-fixed-group">
<label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="bulk-price-fixed">Fixed Price ($)</label>
<input class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="bulk-price-fixed" name="fixed-price" placeholder="e.g., 5.00" step="0.01" type="number"/>
</div>
</div>
<div class="mt-6 flex justify-end">
<button class="btn btn-primary" type="submit">Apply and List Cards</button>
</div>
</form>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1003]" id="bulk-review-modal">
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl flex flex-col" style="height: 90vh;">
<div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
<h2 class="text-xl font-bold">Review and Price Items for Sale</h2>
<button class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="close-bulk-review-modal">×</button>
</div>
<div class="p-4 bg-gray-50 dark:bg-gray-700/50 border-b dark:border-gray-700">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium" for="bulk-apply-percentage">Apply % to All</label>
<div class="flex items-center">
<input class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="bulk-apply-percentage-input" placeholder="e.g., 75" type="number"/>
<button class="ml-2 btn btn-primary" id="bulk-apply-percentage-btn">%</button>
</div>
</div>
</div>
</div>
<div class="flex-grow overflow-y-auto p-4 space-y-2" id="bulk-review-list">
</div>
<div class="p-4 border-t dark:border-gray-700">
<button class="btn btn-success w-full" id="finalize-bulk-list-btn">Finalize and List Selected Cards</button>
</div>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="loginModal"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6"><div class="flex justify-between items-center"><h2 class="text-xl font-bold">Login</h2><button class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="closeLoginModal">×</button></div><form class="mt-4 space-y-4" id="loginForm"><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="loginEmail" placeholder="Email" required="" type="email"/><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="loginPassword" placeholder="Password" required="" type="password"/><p class="text-red-500 text-sm hidden" id="login-error-message"></p><button class="w-full bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700" type="submit">Login</button><button class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold py-2 rounded-md border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center justify-center" id="googleLoginButton" type="button"><img alt="Google icon" class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg"/>Sign in with Google</button></form></div></div>
<div class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" id="registerModal"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6"><div class="flex justify-between items-center"><h2 class="text-xl font-bold">Register</h2><button class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="closeRegisterModal">×</button></div><form class="mt-4 space-y-4" id="registerForm"><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="registerEmail" placeholder="Email" required="" type="email"/><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="registerPassword" placeholder="Password" required="" type="password"/><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="registerCity" placeholder="City" type="text"/><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="registerCountry" placeholder="Country" type="text"/><input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="registerFavoriteTcg" placeholder="Favorite TCG" type="text"/><p class="text-red-500 text-sm hidden" id="register-error-message"></p><button class="w-full bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700" type="submit">Register</button><button class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold py-2 rounded-md border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center justify-center" id="googleRegisterButton" type="button"><img alt="Google icon" class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg"/>Register with Google</button></form></div></div>
<div class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1003]" id="csv-import-modal">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg flex flex-col">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold">Import from CSV</h2>
            <button class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="close-csv-import-modal">×</button>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-gray-600 dark:text-gray-400">Select a CSV file to import. Compatible with ManaBox exports.</p>
            <input type="file" id="csv-file-input" accept=".csv" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"/>
            <button id="start-csv-import-btn" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700" disabled>Parse CSV</button>
            <div id="csv-import-status" class="text-sm text-center p-2 rounded-md"></div>
        </div>
    </div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1004]" id="csv-review-modal">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl flex flex-col" style="height: 90vh;">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold">Review CSV Import</h2>
            <button class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl font-bold" id="close-csv-review-modal">×</button>
        </div>
        <div class="flex-grow overflow-y-auto p-4">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Name</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Set</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Condition</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Language</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Foil</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="csv-review-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                </tbody>
            </table>
        </div>
        <div class="p-4 border-t dark:border-gray-700">
            <button class="btn btn-success w-full" id="finalize-csv-import-btn">Finalize Import</button>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
<script src="js/auth.js"></script>
<script src="js/darkmode.js"></script>
<script src="js/messenger.js"></script>
<script src="js/modules/collection-app.js" type="module"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
        }
    });
</script>
</body>
</html>

This is marketplace.html:
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Marketplace - HatakeSocial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <link href="css/style.css" rel="stylesheet"/>
    <link href="/manifest.json" rel="manifest"/>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 font-sans">
<div class="flex h-screen flex-col">
    <!-- Header -->
    <header class="h-28 flex items-center justify-between px-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0 bg-white dark:bg-gray-800">
        <div class="flex items-center">
            <button class="lg:hidden mr-4 text-gray-600 dark:text-gray-300" id="sidebar-toggle">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <a class="flex flex-col items-center space-y-1" href="app.html">
                <img alt="HatakeSocial Logo" class="h-16" src="https://i.imgur.com/B06rBhI.png"/>
            </a>
        </div>
        <div class="relative flex-grow max-w-xl mx-4">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input class="w-full pl-12 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-full bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" id="main-search-bar" placeholder="Search for cards, users, or articles..." type="text"/>
        </div>
        <div class="flex items-center space-x-5" id="user-actions">
            <!-- Dark mode toggle and currency selector will be injected here -->
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" id="sidebar-overlay"></div>
        <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-50 lg:relative lg:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out" id="sidebar">
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="app.html"><i class="fas fa-home w-6 text-center"></i><span class="ml-3">Feed</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="messages.html"><i class="fas fa-comments w-6 text-center"></i><span class="ml-3">Messages</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="community.html"><i class="fas fa-users w-6 text-center"></i><span class="ml-3">Community</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="articles.html?type=tcg"><i class="fas fa-newspaper w-6 text-center"></i><span class="ml-3">TCG Articles</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="articles.html?type=blog"><i class="fas fa-blog w-6 text-center"></i><span class="ml-3">Hatake Blog</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="events.html"><i class="fas fa-calendar-alt w-6 text-center"></i><span class="ml-3">Events</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="my_collection.html"><i class="fas fa-layer-group w-6 text-center"></i><span class="ml-3">My Collection</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="deck.html"><i class="fas fa-book-open w-6 text-center"></i><span class="ml-3">Deck Builder</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="shop.html"><i class="fas fa-shopping-cart w-6 text-center"></i><span class="ml-3">Shop</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-md" href="marketplace.html"><i class="fas fa-store w-6 text-center"></i><span class="ml-3">Marketplace</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="trades.html"><i class="fas fa-exchange-alt w-6 text-center"></i><span class="ml-3">Trades</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="profile.html"><i class="fas fa-user w-6 text-center"></i><span class="ml-3">Profile</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="settings.html"><i class="fas fa-cog w-6 text-center"></i><span class="ml-3">Settings</span></a>
                <a class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md" href="about.html"><i class="fas fa-info-circle w-6 text-center"></i><span class="ml-3">About Us</span></a>
            </nav>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700" id="auth-container-sidebar"></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex overflow-hidden">
            <div class="flex flex-1 flex-col lg:flex-row gap-6 p-6 overflow-y-auto">
                <!-- Filters Sidebar -->
                <aside class="w-full lg:w-1/4 xl:w-1/5 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 h-fit">
                     <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Filters</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1" for="gameFilter">Game</label>
                        <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="gameFilter">
                            <option value="all">All Games</option>
                            <option value="Magic: The Gathering">Magic: The Gathering</option>
                            <option value="Pokémon">Pokémon</option>
                        </select>
                    </div>
                    <button class="text-blue-600 dark:text-blue-400 hover:underline mb-4 text-sm w-full text-left" id="toggleAdvancedFilters">
                        Show Advanced Filters <i class="fas fa-chevron-down ml-1 transition-transform inline-block"></i>
                    </button>
                    <div class="hidden space-y-4" id="advancedFilters">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1" for="setFilter">Set/Edition</label>
                            <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="setFilter">
                                <option value="all">All Sets</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Price Range</label>
                            <div class="flex space-x-2">
                                <input class="w-1/2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" id="minPrice" placeholder="Min" type="number"/>
                                <input class="w-1/2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" id="maxPrice" placeholder="Max" type="number"/>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Condition</label>
                            <div class="space-y-2 text-sm text-gray-800 dark:text-gray-300" id="conditionFilters">
                                <div class="flex items-center"><input class="h-4 w-4 bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-blue-600 focus:ring-blue-500 mr-2" type="checkbox" value="Near Mint"/><label>Near Mint</label></div>
                                <div class="flex items-center"><input class="h-4 w-4 bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-blue-600 focus:ring-blue-500 mr-2" type="checkbox" value="Lightly Played"/><label>Lightly Played</label></div>
                                <div class="flex items-center"><input class="h-4 w-4 bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-blue-600 focus:ring-blue-500 mr-2" type="checkbox" value="Moderately Played"/><label>Moderately Played</label></div>
                                <div class="flex items-center"><input class="h-4 w-4 bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-blue-600 focus:ring-blue-500 mr-2" type="checkbox" value="Heavily Played"/><label>Heavily Played</label></div>
                                <div class="flex items-center"><input class="h-4 w-4 bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-blue-600 focus:ring-blue-500 mr-2" type="checkbox" value="Damaged"/><label>Damaged</label></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center text-sm text-gray-800 dark:text-gray-300">
                                <input class="h-4 w-4 bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-blue-600 focus:ring-blue-500 mr-2" id="foilFilter" type="checkbox"/>
                                <label for="foilFilter">Foil Only</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1" for="locationFilter">Seller Location (Country)</label>
                            <input class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="locationFilter" placeholder="e.g., USA, Japan" type="text"/>
                        </div>
                    </div>
                </aside>

                <!-- Listings -->
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Marketplace</h1>
                        <div class="flex items-center space-x-4">
                            <select class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" id="sortOptions">
                                <option value="newly-listed">Newly Listed</option>
                                <option value="price-asc">Price: Low to High</option>
                                <option value="price-desc">Price: High to Low</option>
                            </select>
                            <div class="flex items-center bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-1">
                                <button class="px-3 py-1 rounded bg-blue-600 text-white" id="gridViewBtn" title="Grid View"><i class="fas fa-th-large"></i></button>
                                <button class="px-3 py-1 rounded text-gray-500 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600" id="listViewBtn" title="List View"><i class="fas fa-list"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="h-full" id="listingsContainer">
                        <div class="text-center p-10">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                            <p class="mt-2 text-gray-600 dark:text-gray-400">Loading Listings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- Modals and scripts -->
<div class="fixed z-[1005] pointer-events-none hidden rounded-xl shadow-lg border-4 border-gray-400" id="card-preview-tooltip" style="width: 260px;">
    <img alt="Card Preview" class="w-full rounded-lg" src=""/>
</div>
<!-- ... other modals ... -->
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js" type="text/javascript"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
<script src="js/auth.js"></script>
<script src="js/notifications.js"></script>
<script src="js/cart.js"></script>
<script src="js/darkmode.js"></script>
<script src="js/messenger.js"></script>
<script src="js/marketplace.js" type="module"></script>
<script>
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });
    }
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });
    }
</script>
<script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
</script>
</body>
</html>
This is marketplace.js:
/**
 * @file public/js/marketplace.js
 * @description Handles all logic for the TCG Marketplace page for HatakeSocial.
 * @note This script uses the Firebase v9 compat libraries.
 */

// Import currency module for price conversion
import * as Currency from './modules/currency.js';
import { createCurrencySelector } from './modules/ui.js';

// --- STATE MANAGEMENT ---
let allListings = [];           // Master list of all listings from Firestore
let filteredListings = [];      // Listings after filters and sorting are applied
let currentView = 'grid';       // 'grid' or 'list'

// --- DOM ELEMENT REFERENCES ---
const listingsContainer = document.getElementById('listingsContainer');
const mainSearchInput = document.getElementById('main-search-bar'); // Use the header search bar
const gameFilter = document.getElementById('gameFilter');
const setFilter = document.getElementById('setFilter');
const minPriceInput = document.getElementById('minPrice');
const maxPriceInput = document.getElementById('maxPrice');
const conditionFiltersContainer = document.getElementById('conditionFilters');
const foilFilter = document.getElementById('foilFilter');
const locationFilter = document.getElementById('locationFilter');
const sortOptions = document.getElementById('sortOptions');
const gridViewBtn = document.getElementById('gridViewBtn');
const listViewBtn = document.getElementById('listViewBtn');
const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFilters');
const advancedFiltersContainer = document.getElementById('advancedFilters');

// --- UTILITY FUNCTIONS ---
const debounce = (func, delay) => {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
};

// --- DATA FETCHING ---
async function fetchMarketplaceData() {
    listingsContainer.innerHTML = `
        <div class="text-center p-10">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Loading Listings...</p>
        </div>`;

    try {
        const db = firebase.firestore();
        const listingsRef = db.collection('marketplaceListings');
        const querySnapshot = await listingsRef.orderBy('timestamp', 'desc').get();

        allListings = querySnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        filteredListings = [...allListings];

        if (allListings.length === 0) {
            listingsContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-10">The marketplace is currently empty.</p>`;
        } else {
            populateSetFilter();
            renderListings();
        }

    } catch (error) {
        console.error("Error fetching marketplace listings:", error);
        listingsContainer.innerHTML = `<p class="text-center text-red-500 py-10">Could not load listings. Please try again later.</p>`;
    }
}

// --- RENDERING LOGIC ---
function renderListings() {
    listingsContainer.innerHTML = '';

    if (filteredListings.length === 0) {
        listingsContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-10">No cards found. Try adjusting your filters.</p>`;
        return;
    }

    if (currentView === 'grid') {
        renderGridView();
    } else {
        renderListView();
    }
}

function renderGridView() {
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 gap-4';

    filteredListings.forEach(listing => {
        const cardData = listing.cardData;
        const imageUrl = cardData.image_uris?.large || cardData.image_uris?.normal || 'https://placehold.co/223x310?text=No+Image';
        const displayPrice = Currency.convertFromSekAndFormat(listing.price);

        const cardElement = document.createElement('div');
        cardElement.className = 'card-container group relative rounded-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform duration-200 shadow-lg bg-gray-200 dark:bg-gray-800';
        cardElement.dataset.imageUrl = imageUrl;

        cardElement.onclick = () => window.location.href = `/card-view.html?id=${listing.id}`;

        cardElement.innerHTML = `
            <img src="${imageUrl}" alt="${cardData.name}" class="w-full h-auto object-cover rounded-t-lg">
            <div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">${displayPrice}</div>
            <div class="p-2">
                <h3 class="font-bold text-sm truncate">${cardData.name}</h3>
                <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1 mt-1">
                    <p><strong>Condition:</strong> ${listing.condition}</p>
                    ${listing.isFoil ? '<p class="text-blue-400 font-semibold">Foil</p>' : ''}
                    <p class="truncate"><strong>Notes:</strong> ${listing.notes || 'None'}</p>
                </div>
            </div>
        `;
        grid.appendChild(cardElement);
    });

    listingsContainer.appendChild(grid);
}


function renderListView() {
    const tableContainer = document.createElement('div');
    tableContainer.className = 'overflow-x-auto bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700';

    let tableHTML = `
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Card Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Set</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Condition</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Price</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Seller</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;

    filteredListings.forEach(listing => {
        const cardData = listing.cardData;
        const sellerData = listing.sellerData;
        const displayPrice = Currency.convertFromSekAndFormat(listing.price);

        tableHTML += `
            <tr class="hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" onclick="window.location.href='/card-view.html?id=${listing.id}'">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-8">
                            <img class="h-10 w-8 rounded object-cover" src="${cardData.image_uris?.small || 'https://placehold.co/32'}" alt="">
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${cardData.name} ${listing.isFoil ? '<i class="fas fa-star text-yellow-400 text-xs ml-1" title="Foil"></i>' : ''}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${cardData.set_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${listing.condition}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600 dark:text-blue-400">${displayPrice}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    <a href="/profile.html?uid=${sellerData.uid}" onclick="event.stopPropagation()" class="flex items-center space-x-2 group">
                        <img class="h-8 w-8 rounded-full" src="${sellerData.photoURL || 'https://placehold.co/32'}" alt="">
                        <div>
                            <div class="text-sm font-medium text-gray-900 dark:text-white group-hover:underline">${sellerData.displayName}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${sellerData.country || 'N/A'}</div>
                        </div>
                    </a>
                </td>
            </tr>`;
    });

    tableHTML += `</tbody></table>`;
    tableContainer.innerHTML = tableHTML;
    listingsContainer.appendChild(tableContainer);
}

// --- FILTERING AND SORTING LOGIC ---
function applyFiltersAndSort() {
    let listings = [...allListings];

    const searchTerm = mainSearchInput.value.toLowerCase();
    const selectedGame = gameFilter.value;
    const selectedSet = setFilter.value;
    const minPrice = parseFloat(minPriceInput.value);
    const maxPrice = parseFloat(maxPriceInput.value);
    const selectedConditions = Array.from(conditionFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
    const showFoilOnly = foilFilter.checked;
    const sellerLocation = locationFilter.value.toLowerCase();

    if (searchTerm) listings = listings.filter(l => l.cardData.name.toLowerCase().includes(searchTerm));
    if (selectedGame !== 'all') listings = listings.filter(l => l.cardData.game === selectedGame);

    populateSetFilter(listings);

    if (selectedSet !== 'all') listings = listings.filter(l => l.cardData.set_name === selectedSet);
    if (!isNaN(minPrice)) listings = listings.filter(l => l.price >= minPrice);
    if (!isNaN(maxPrice)) listings = listings.filter(l => l.price <= maxPrice);
    if (selectedConditions.length > 0) listings = listings.filter(l => selectedConditions.includes(l.condition));
    if (showFoilOnly) listings = listings.filter(l => l.isFoil);
    if (sellerLocation) listings = listings.filter(l => l.sellerData.country && l.sellerData.country.toLowerCase().includes(sellerLocation));

    const sortBy = sortOptions.value;
    switch (sortBy) {
        case 'price-asc':
            listings.sort((a, b) => a.price - b.price);
            break;
        case 'price-desc':
            listings.sort((a, b) => b.price - a.price);
            break;
        case 'newly-listed':
        default:
            listings.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
    }

    filteredListings = listings;
    renderListings();
}

function populateSetFilter(listings = allListings) {
    const currentSetValue = setFilter.value;
    const setNames = [...new Set(listings.map(l => l.cardData.set_name))].sort();

    setFilter.innerHTML = '<option value="all">All Sets</option>';
    setNames.forEach(setName => {
        const option = document.createElement('option');
        option.value = setName;
        option.textContent = setName;
        setFilter.appendChild(option);
    });

    if (setNames.includes(currentSetValue)) {
        setFilter.value = currentSetValue;
    }
}

// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', async () => {
    await Currency.initCurrency('SEK');
    createCurrencySelector('user-actions');
    
    fetchMarketplaceData();

    // Search and filter event listeners
    mainSearchInput.addEventListener('input', debounce(applyFiltersAndSort, 300));
    gameFilter.addEventListener('change', applyFiltersAndSort);
    setFilter.addEventListener('change', applyFiltersAndSort);
    minPriceInput.addEventListener('input', debounce(applyFiltersAndSort, 500));
    maxPriceInput.addEventListener('input', debounce(applyFiltersAndSort, 500));
    foilFilter.addEventListener('change', applyFiltersAndSort);
    locationFilter.addEventListener('input', debounce(applyFiltersAndSort, 300));
    sortOptions.addEventListener('change', applyFiltersAndSort);

    // View toggle event listeners
    gridViewBtn.addEventListener('click', () => {
        currentView = 'grid';
        gridViewBtn.classList.add('bg-blue-600', 'text-white');
        gridViewBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        listViewBtn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        listViewBtn.classList.remove('bg-blue-600', 'text-white');
        renderListings();
    });

    listViewBtn.addEventListener('click', () => {
        currentView = 'list';
        listViewBtn.classList.add('bg-blue-600', 'text-white');
        listViewBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        gridViewBtn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        gridViewBtn.classList.remove('bg-blue-600', 'text-white');
        renderListings();
    });
    
    // Card hover preview functionality
    const tooltip = document.getElementById('card-preview-tooltip');
    listingsContainer.addEventListener('mouseover', (e) => {
        const cardElement = e.target.closest('.card-container');
        if (cardElement && cardElement.dataset.imageUrl) {
            tooltip.querySelector('img').src = cardElement.dataset.imageUrl;
            tooltip.classList.remove('hidden');
        }
    });
    listingsContainer.addEventListener('mouseout', () => {
        tooltip.classList.add('hidden');
    });
    listingsContainer.addEventListener('mousemove', (e) => {
        if (!tooltip.classList.contains('hidden')) {
            tooltip.style.left = `${e.clientX + 15}px`;
            tooltip.style.top = `${e.clientY}px`;
        }
    });

    // Advanced filters toggle
    toggleAdvancedFiltersBtn.addEventListener('click', () => {
        advancedFiltersContainer.classList.toggle('hidden');
        const isHidden = advancedFiltersContainer.classList.contains('hidden');
        toggleAdvancedFiltersBtn.innerHTML = isHidden 
            ? 'Show Advanced Filters <i class="fas fa-chevron-down ml-1 transition-transform inline-block"></i>' 
            : 'Hide Advanced Filters <i class="fas fa-chevron-up ml-1 transition-transform inline-block"></i>';
    });

    // Condition filter checkboxes
    conditionFiltersContainer.addEventListener('change', applyFiltersAndSort);
    
    // Re-render on currency change
    document.addEventListener('currencyChanged', renderListings);
});


Can you take the UI, like the navbar, the header, the logo and everything from my_collection.html and have the layout from there whilst having the marketplace functions in the middle of it?
We also need the currency changer in the header to be functional in marketplace and be saved throughout the session for my_collection.html, settings.html, shop.html and marketplace.html