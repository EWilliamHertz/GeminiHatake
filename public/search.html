<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - HatakeSocial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            plugins: [
                function ({ addVariant }) {
                    addVariant('has-[:checked]', '&:has(:checked)')
                }
            ]
        };
    </script>
    <link rel="manifest" href="/manifest.json">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 font-sans overflow-hidden">
    <div class="flex h-screen">
        <!-- Sidebar Overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" id="sidebar-overlay"></div>
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-50 lg:relative lg:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out" id="sidebar">
            <div class="h-28 flex items-center justify-center border-b border-gray-200 dark:border-gray-700 px-4">
                <a href="app.html" class="flex flex-col items-center space-y-1">
                    <img src="https://firebasestorage.googleapis.com/v0/b/hatakesocial-88b5e.firebasestorage.app/o/IMG_7951.png?alt=media&token=e7c2dc48-2836-4feb-9fc7-324aecacba6b" 
                         alt="HatakeSocial Logo" class="h-16" 
                         onerror="this.onerror=null; this.src='https://placehold.co/150x40?text=HatakeSocial';">
                    <span class="font-bold text-lg text-blue-600 dark:text-blue-400">HatakeSocial</span>
                </a>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                <a href="app.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-home w-6 text-center"></i>
                    <span class="ml-3">Feed</span>
                </a>
                <a href="messages.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-comments w-6 text-center"></i>
                    <span class="ml-3">Messages</span>
                </a>
                <a href="community.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-users w-6 text-center"></i>
                    <span class="ml-3">Community</span>
                </a>
                <a href="articles.html?type=tcg" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-newspaper w-6 text-center"></i>
                    <span class="ml-3">TCG Articles</span>
                </a>
                <a href="articles.html?type=blog" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-blog w-6 text-center"></i>
                    <span class="ml-3">Hatake Blog</span>
                </a>
                <a href="events.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-calendar-alt w-6 text-center"></i>
                    <span class="ml-3">Events</span>
                </a>
                <a href="my_collection.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-layer-group w-6 text-center"></i>
                    <span class="ml-3">My Collection</span>
                </a>
                <a href="deck.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-book-open w-6 text-center"></i>
                    <span class="ml-3">Deck Builder</span>
                </a>
                <a href="shop.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-shopping-cart w-6 text-center"></i>
                    <span class="ml-3">Shop</span>
                </a>
                <a href="marketplace.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-store w-6 text-center"></i>
                    <span class="ml-3">Marketplace</span>
                </a>
                <a href="trades.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-exchange-alt w-6 text-center"></i>
                    <span class="ml-3">Trades</span>
                </a>
                <a href="profile.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-user w-6 text-center"></i>
                    <span class="ml-3">Profile</span>
                </a>
                <a href="settings.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-cog w-6 text-center"></i>
                    <span class="ml-3">Settings</span>
                </a>
                <a href="about.html" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md">
                    <i class="fas fa-info-circle w-6 text-center"></i>
                    <span class="ml-3">About Us</span>
                </a>
            </nav>
            <div class="px-4 py-4 border-t border-gray-200 dark:border-gray-700">
                <div id="auth-container-sidebar"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-28 flex items-center justify-between px-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center">
                    <button class="lg:hidden mr-4 text-gray-600 dark:text-gray-300" id="sidebar-toggle">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" 
                               placeholder="Search for cards, users, or articles..." 
                               class="w-full md:w-96 pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               id="main-search-bar">
                    </div>
                </div>
                <div class="flex items-center space-x-5" id="user-actions"></div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="container mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <!-- Filters Sidebar -->
                        <aside class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md h-fit sticky top-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold">Filters</h2>
                                <button class="text-sm text-blue-600 dark:text-blue-400 hover:underline" id="clear-filters">Clear All</button>
                            </div>
                            
                            <!-- Category Filter -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                                <select class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" id="filter-category">
                                    <option value="cards" selected>Cards</option>
                                    <option value="users">Users</option>
                                    <option value="articles">Articles</option>
                                </select>
                            </div>

                            <!-- TCG Selection -->
                            <div class="mb-6" id="tcg-filter-container">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Trading Card Game</label>
                                <select class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="filter-tcg">
                                    <option value="mtg" selected>Magic: The Gathering</option>
                                    <option value="pokemon">Pok√©mon</option>
                                    <option value="lorcana">Lorcana</option>
                                    <option value="gundam">Gundam</option>
                                </select>
                            </div>

                            <!-- Price Range Filter -->
                            <div class="mb-6" id="price-filter-container">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price Range (USD)</label>
                                <div class="flex space-x-2">
                                    <input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="price-min" min="0" placeholder="Min" step="0.01" type="number"/>
                                    <input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="price-max" min="0" placeholder="Max" step="0.01" type="number"/>
                                </div>
                            </div>
                        </aside>

                        <!-- Results Area -->
                        <div class="lg:col-span-3">
                            <!-- Search Header -->
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                                <h1 class="text-3xl font-bold mb-4 sm:mb-0">
                                    Search Results for "<span id="search-query-display"></span>"
                                </h1>
                                <!-- Sort Controls -->
                                <div class="flex items-center space-x-4">
                                    <select class="appearance-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="sort-select">
                                        <option value="relevance">Relevance</option>
                                        <option value="name-asc">Name A-Z</option>
                                        <option value="name-desc">Name Z-A</option>
                                        <option value="price-asc">Price Low to High</option>
                                        <option value="price-desc">Price High to Low</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Loading Indicator -->
                            <div class="hidden text-center p-8" id="loading-indicator">
                                <div class="inline-flex items-center">
                                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mr-4"></i>
                                    <div>
                                        <p class="text-lg font-medium">Searching...</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Finding the best results for you</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Search Results -->
                            <div class="space-y-8" id="search-results-area">
                                <p class="text-center text-gray-500 dark:text-gray-400 text-lg">Please enter a search term in the bar above.</p>
                            </div>

                            <!-- Pagination Controls -->
                            <div class="mt-8 flex justify-center items-center space-x-4" id="pagination-controls" style="display: none;">
                                <button class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed" id="prev-page" disabled>
                                    <i class="fas fa-chevron-left mr-2"></i>Previous
                                </button>
                                <span class="text-sm text-gray-600 dark:text-gray-400" id="page-info">Page 1</span>
                                <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" id="next-page">
                                    Next<i class="fas fa-chevron-right ml-2"></i>
                                </button>
                                <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" id="load-more">
                                    Load More Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="js/darkmode.js"></script>
    <script src="js/auth.js"></script>

    <!-- Search Functionality -->
    <script>
        console.log('Search page loading...');
        
        // Global variables
        let currentQuery = '';
        let currentPage = 1;
        let currentCategory = 'cards';
        let currentTcg = 'mtg';
        let allResults = [];
        let searchTimeout = null;
        const RESULTS_PER_PAGE = 20;
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready, initializing search...');
            
            // DOM Elements
            const headerSearchBar = document.getElementById('main-search-bar');
            const resultsArea = document.getElementById('search-results-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const searchQueryDisplay = document.getElementById('search-query-display');
            const tcgFilter = document.getElementById('filter-tcg');
            const categoryFilter = document.getElementById('filter-category');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const tcgFilterContainer = document.getElementById('tcg-filter-container');
            const priceFilterContainer = document.getElementById('price-filter-container');
            const paginationControls = document.getElementById('pagination-controls');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const loadMoreBtn = document.getElementById('load-more');
            const pageInfo = document.getElementById('page-info');
            
            // Search functions
            const searchMTG = async (query, page = 1) => {
                try {
                    const encodedUrl = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&page=${page}`;
                    const response = await fetch(encodedUrl);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            return { data: [], has_more: false, total_cards: 0 };
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return {
                        data: data.data || [],
                        has_more: data.has_more || false,
                        total_cards: data.total_cards || 0
                    };
                } catch (error) {
                    console.error('MTG search error:', error);
                    throw error;
                }
            };

            // Use ScryDex for all card searches including Magic: The Gathering
            const API = window.API || {
                searchCards: async (query, game) => {
                    try {
                        console.log(`Searching ${game} for: ${query}`);
                        
                        // Use Firebase Functions for ScryDex for ALL games including MTG
                        const searchScryDexFunction = firebase.functions().httpsCallable('searchScryDex');
                        const result = await searchScryDexFunction({ cardName: query, game: game });
                        
                        console.log('ScryDex result:', result);
                        
                        let cardData = [];
                        if (result && result.data && Array.isArray(result.data.data)) {
                            cardData = result.data.data;
                        } else if (result && Array.isArray(result.data)) {
                            cardData = result.data;
                        }
                        
                        // Clean the data using the same logic as the API module
                        return cardData.map(card => cleanScryDexData(card, game));
                    } catch (error) {
                        console.error(`Search error for ${game}:`, error);
                        throw error;
                    }
                }
            };

            // Clean ScryDex data function (updated for all games including MTG)
            const cleanScryDexData = (card, game) => {
                try {
                    // Extract images properly from ScryDex structure
                    let imageUris = { small: null, normal: null, large: null };
                    if (card.images && Array.isArray(card.images) && card.images.length > 0) {
                        const img = card.images[0];
                        imageUris = {
                            small: img.small || img.medium || img.large || null,
                            normal: img.medium || img.large || img.small || null,
                            large: img.large || img.medium || img.small || null,
                        };
                    }
                    
                    // Extract pricing from variants
                    let prices = {};
                    let marketPrice = null;
                    if (card.variants && Array.isArray(card.variants)) {
                        card.variants.forEach(variant => {
                            if (variant.prices && Array.isArray(variant.prices)) {
                                variant.prices.forEach(price => {
                                    if (price.market && !marketPrice) {
                                        marketPrice = price.market;
                                    }
                                    const priceKey = `${variant.name || 'normal'}_${price.condition || price.type || 'market'}`;
                                    prices[priceKey] = price.market || price.low || price.high || price.average;
                                });
                            }
                        });
                    }
                    
                    // If no market price found, try to get from first variant
                    if (!marketPrice && card.variants && card.variants[0] && card.variants[0].prices && card.variants[0].prices[0]) {
                        marketPrice = card.variants[0].prices[0].market || card.variants[0].prices[0].low;
                    }

                    const cleaned = {
                        api_id: card.id,
                        name: card.Name || card.name || 'Unknown Card',
                        set: card.expansion?.id || card.set || 'unknown',
                        set_name: card.expansion?.name || card.set_name || 'Unknown Set',
                        rarity: card.rarity || 'Common',
                        image_uris: imageUris,
                        prices: prices,
                        market_price: marketPrice,
                        collector_number: card.number || card.collector_number || '',
                        game: game,
                        // Keep original card data for card-view
                        original_data: card
                    };

                    switch (game) {
                        case 'mtg':
                            cleaned.mana_cost = card.mana_cost || '';
                            cleaned.cmc = card.cmc || 0;
                            cleaned.type_line = card.type_line || '';
                            cleaned.oracle_text = card.oracle_text || '';
                            cleaned.color_identity = card.color_identity || [];
                            cleaned.rulings = card.rulings || [];
                            break;
                        case 'pokemon':
                            cleaned.types = card.types || [];
                            cleaned.hp = card.hp || null;
                            cleaned.supertype = card.supertype || '';
                            cleaned.subtypes = card.subtypes || [];
                            break;
                        case 'lorcana':
                            cleaned.cost = card.Cost || 0;
                            cleaned.type = card.Type || '';
                            cleaned.color = card.Color || '';
                            cleaned.inkable = card.Inkable || false;
                            cleaned.strength = card.Strength || null;
                            cleaned.willpower = card.Willpower || null;
                            cleaned.lore = card.Lore || null;
                            break;
                        case 'gundam':
                            cleaned.code = card.code || '';
                            cleaned.cost = card.cost || 0;
                            cleaned.color = card.color || '';
                            cleaned.card_type = card.card_type || '';
                            break;
                    }
                    return cleaned;
                } catch (error) {
                    console.error(`Error cleaning ScryDex data for ${game}:`, error, card);
                    return {
                        api_id: `${game}_error_${Date.now()}`,
                        name: card.name || 'Error Loading Card',
                        set_name: 'Unknown Set',
                        rarity: 'Common',
                        image_uris: null,
                        prices: { usd: null, usd_foil: null },
                        game: game
                    };
                }
            };

            // User search function
            const searchUsers = async (query) => {
                try {
                    console.log('Searching users with query:', query);
                    const usersRef = firebase.firestore().collection('users');
                    const queryLower = query.toLowerCase();
                    
                    // Search by displayName_lower field for case-insensitive search
                    const snapshot = await usersRef
                        .where('displayName_lower', '>=', queryLower)
                        .where('displayName_lower', '<=', queryLower + '\uf8ff')
                        .limit(50)
                        .get();
                    
                    const users = [];
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        users.push({
                            id: doc.id,
                            displayName: userData.displayName || 'Unknown User',
                            email: userData.email || '',
                            photoURL: userData.photoURL || 'https://via.placeholder.com/100x100?text=User',
                            bio: userData.bio || '',
                            joinDate: userData.joinDate || null
                        });
                    });
                    
                    console.log(`Found ${users.length} users`);
                    return {
                        data: users,
                        has_more: false,
                        total_cards: users.length
                    };
                } catch (error) {
                    console.error('User search error:', error);
                    throw error;
                }
            };

            // Articles search function
            const searchArticles = async (query) => {
                try {
                    console.log('Searching articles with query:', query);
                    const articlesRef = firebase.firestore().collection('articles');
                    const queryLower = query.toLowerCase();
                    
                    // Search by title and content
                    const snapshot = await articlesRef
                        .where('searchTerms', 'array-contains', queryLower)
                        .orderBy('publishedAt', 'desc')
                        .limit(50)
                        .get();
                    
                    const articles = [];
                    snapshot.forEach(doc => {
                        const articleData = doc.data();
                        articles.push({
                            id: doc.id,
                            title: articleData.title || 'Untitled Article',
                            excerpt: articleData.excerpt || '',
                            content: articleData.content || '',
                            author: articleData.author || 'Unknown Author',
                            publishedAt: articleData.publishedAt || null,
                            imageUrl: articleData.imageUrl || 'https://via.placeholder.com/400x200?text=Article',
                            tags: articleData.tags || []
                        });
                    });
                    
                    console.log(`Found ${articles.length} articles`);
                    return {
                        data: articles,
                        has_more: false,
                        total_cards: articles.length
                    };
                } catch (error) {
                    console.error('Article search error:', error);
                    throw error;
                }
            };
            
            // Main search function with proper pagination
            const searchContent = async (query, category, tcg, page = 1) => {
                try {
                    switch (category) {
                        case 'cards':
                            const gameMap = {
                                'pokemon': 'pokemon',
                                'lorcana': 'lorcana', 
                                'gundam': 'gundam',
                                'magic: the gathering': 'mtg'
                            };
                            const game = gameMap[tcg.toLowerCase()] || 'mtg';
                            const allResults = await API.searchCards(query, game);
                            
                            // Implement client-side pagination
                            const startIndex = (page - 1) * RESULTS_PER_PAGE;
                            const endIndex = startIndex + RESULTS_PER_PAGE;
                            const paginatedResults = allResults.slice(startIndex, endIndex);
                            
                            return {
                                data: paginatedResults,
                                has_more: endIndex < allResults.length,
                                total_cards: allResults.length,
                                all_results: allResults // Store all results for pagination
                            };
                        case 'users':
                            return await searchUsers(query);
                        case 'articles':
                            return await searchArticles(query);
                        default:
                            return await searchMTG(query, page);
                    }
                } catch (error) {
                    console.error(`Search failed for ${category}:`, error);
                    throw error;
                }
            };
            
            // Render functions
            const renderCard = (card, tcg) => {
                const name = card.name || 'Unknown Card';
                let imageUrl = 'https://via.placeholder.com/200x280?text=No+Image';
                let price = 'N/A';
                let setName = 'Unknown Set';
                
                // Use the cleaned data structure
                imageUrl = card.image_uris?.normal || card.image_uris?.large || card.image_uris?.small || imageUrl;
                setName = card.set_name || 'Unknown Set';
                
                // Handle pricing - use market_price first, then try prices object
                if (card.market_price && !isNaN(parseFloat(card.market_price))) {
                    price = `$${parseFloat(card.market_price).toFixed(2)}`;
                } else if (card.prices && Object.keys(card.prices).length > 0) {
                    const priceKeys = Object.keys(card.prices);
                    const firstPrice = card.prices[priceKeys[0]];
                    if (firstPrice && !isNaN(parseFloat(firstPrice))) {
                        price = `$${parseFloat(firstPrice).toFixed(2)}`;
                    }
                }
                
                const collectorNumber = card.collector_number || card.number || '';
                const rarity = card.rarity || '';
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer" 
                         onclick="openCardDetails('${name.replace(/'/g, "\\'")}', '${tcg}', '${card.api_id || card.id || ''}')">
                        <div class="relative aspect-w-3 aspect-h-4 bg-gray-200 dark:bg-gray-700">
                            <img src="${imageUrl}" alt="${name}" class="w-full h-48 object-cover" 
                                 onerror="this.src='https://via.placeholder.com/200x280?text=No+Image'">
                            ${collectorNumber ? `<div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">#${collectorNumber}</div>` : ''}
                            ${rarity ? `<div class="absolute top-2 left-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded capitalize">${rarity}</div>` : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white truncate" title="${name}">${name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 truncate" title="${setName}">${setName}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-green-600 dark:text-green-400">${price}</span>
                                <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors" 
                                        onclick="event.stopPropagation(); addCardToCollection('${card.api_id || card.id}', '${name.replace(/'/g, "\\'")}', '${tcg}', '${imageUrl}', '${price}')">
                                    Add to Collection
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderUser = (user) => {
                const joinDate = user.joinDate ? user.joinDate.toDate().toLocaleDateString() : 'Unknown';
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='profile.html?uid=${user.id}'">
                        <div class="flex items-center space-x-4">
                            <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="${user.displayName}" class="w-12 h-12 rounded-full object-cover">
                            <div class="flex-grow">
                                <h3 class="font-semibold text-lg">${user.displayName}</h3>
                                <p class="text-gray-600 dark:text-gray-400">${user.email}</p>
                                <p class="text-sm text-gray-500">Joined ${joinDate}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-gray-700 dark:text-gray-300">${user.bio || 'No bio available.'}</p>
                        <button class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors" onclick="event.stopPropagation(); followUser('${user.id}')">
                            Follow
                        </button>
                    </div>
                `;
            };

            const renderArticle = (article) => {
                const publishDate = article.publishedAt ? article.publishedAt.toDate().toLocaleDateString() : 'Unknown';
                const excerpt = article.excerpt || (article.content ? article.content.substring(0, 150) + '...' : 'No preview available');
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer" 
                         onclick="openArticle('${article.id}')">
                        <img src="${article.imageUrl}" alt="${article.title}" class="w-full h-48 object-cover" 
                             onerror="this.src='https://via.placeholder.com/400x200?text=Article'">
                        <div class="p-6">
                            <div class="flex items-center space-x-2 mb-2">
                                ${article.tags.map(tag => `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded">${tag}</span>`).join('')}
                            </div>
                            <h3 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">${article.title}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${excerpt}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-500">
                                <span>By ${article.author}</span>
                                <span>${publishDate}</span>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // Perform search function
            const performSearch = async (query, page = 1, append = false) => {
                if (!query || query.trim().length < 2) {
                    resultsArea.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 text-lg">Please enter a search term.</p>';
                    paginationControls.style.display = 'none';
                    return;
                }
                
                currentQuery = query;
                currentPage = page;
                if (headerSearchBar) headerSearchBar.value = query;
                if (searchQueryDisplay) searchQueryDisplay.textContent = query;
                
                // Show loading
                if (!append && loadingIndicator) loadingIndicator.classList.remove('hidden');
                if (!append) resultsArea.innerHTML = '';
                
                try {
                    const selectedCategory = categoryFilter ? categoryFilter.value : 'cards';
                    const selectedTcg = tcgFilter ? tcgFilter.value : 'mtg';
                    currentCategory = selectedCategory;
                    currentTcg = selectedTcg;
                    
                    const results = await searchContent(query, selectedCategory, selectedTcg, page);
                    
                    if (results.data.length === 0 && !append) {
                        resultsArea.innerHTML = `
                            <div class="text-center p-8">
                                <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">No Results Found</h3>
                                <p class="text-gray-600 dark:text-gray-400">Try adjusting your search terms or selecting a different category.</p>
                            </div>
                        `;
                        paginationControls.style.display = 'none';
                    } else {
                        let resultElements = '';
                        
                        if (selectedCategory === 'cards') {
                            resultElements = results.data.map(item => renderCard(item, selectedTcg)).join('');
                        } else if (selectedCategory === 'users') {
                            resultElements = results.data.map(item => renderUser(item)).join('');
                        } else if (selectedCategory === 'articles') {
                            resultElements = results.data.map(item => renderArticle(item)).join('');
                        }
                        
                        const gridClass = selectedCategory === 'cards' ? 
                            'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6' :
                            'space-y-6';
                        
                        if (append) {
                            const existingGrid = resultsArea.querySelector('.results-grid');
                            if (existingGrid) {
                                existingGrid.innerHTML += resultElements;
                            }
                        } else {
                            const categoryName = selectedCategory === 'cards' ? 
                                (tcgFilter.options[tcgFilter.selectedIndex].text) : 
                                selectedCategory;
                            
                            resultsArea.innerHTML = `
                                <div class="mb-4">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        Found ${results.total_cards} result${results.total_cards !== 1 ? 's' : ''} for "${query}" in ${categoryName}
                                    </p>
                                </div>
                                <div class="results-grid ${gridClass}">
                                    ${resultElements}
                                </div>
                            `;
                        }
                        
                        // Update pagination
                        updatePagination(results.has_more, page, results.total_cards);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    resultsArea.innerHTML = `
                        <div class="text-center p-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Search Error</h3>
                            <p class="text-gray-600 dark:text-gray-400">An error occurred while searching: ${error.message}</p>
                        </div>
                    `;
                    paginationControls.style.display = 'none';
                } finally {
                    if (loadingIndicator) loadingIndicator.classList.add('hidden');
                }
            };

            const updatePagination = (hasMore, page, totalResults) => {
                if (totalResults > RESULTS_PER_PAGE || page > 1) {
                    paginationControls.style.display = 'flex';
                    
                    prevPageBtn.disabled = page <= 1;
                    nextPageBtn.disabled = !hasMore;
                    loadMoreBtn.style.display = hasMore ? 'block' : 'none';
                    
                    const startResult = ((page - 1) * RESULTS_PER_PAGE) + 1;
                    const endResult = Math.min(page * RESULTS_PER_PAGE, totalResults);
                    pageInfo.textContent = `Page ${page} (${startResult}-${endResult} of ${totalResults})`;
                } else {
                    paginationControls.style.display = 'none';
                }
            };
            
            // Global functions
            window.performSearch = performSearch;
            
            window.openCardDetails = (cardName, tcg, cardId = '') => {
                console.log('Opening card details for:', cardName, 'from', tcg, 'ID:', cardId);
                // Navigate to card details page
                const params = new URLSearchParams({
                    name: cardName,
                    tcg: tcg
                });
                if (cardId) params.set('id', cardId);
                window.location.href = `card-view.html?${params.toString()}`;
            };
            
            window.addCardToCollection = async (cardId, cardName, tcg, imageUrl, price) => {
                console.log('Adding card to collection:', cardName, 'from', tcg);
                
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        alert('Please log in to add cards to your collection.');
                        return;
                    }
                    
                    const db = firebase.firestore();
                    const cardData = {
                        cardId: cardId,
                        name: cardName,
                        tcg: tcg,
                        imageUrl: imageUrl,
                        price: price,
                        addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: user.uid
                    };
                    
                    await db.collection('collections').doc(user.uid).collection('cards').add(cardData);
                    
                    // Show success message
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Added!';
                    button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    button.classList.add('bg-green-500');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-500');
                        button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error adding card to collection:', error);
                    alert('Error adding card to collection. Please try again.');
                }
            };

            window.openUserProfile = (userId) => {
                console.log('Opening user profile:', userId);
                window.location.href = `profile.html?userId=${userId}`;
            };

            window.followUser = (userId) => {
                console.log('Following user:', userId);
                alert(`Following user - Feature coming soon!`);
            };

            window.openArticle = (articleId) => {
                console.log('Opening article:', articleId);
                window.location.href = `article.html?id=${articleId}`;
            };
            
            // Event listeners
            if (headerSearchBar) {
                headerSearchBar.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearch(headerSearchBar.value);
                    }
                });
                
                // Debounced search as user types
                headerSearchBar.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    if (e.target.value.length >= 2) {
                        searchTimeout = setTimeout(() => {
                            performSearch(e.target.value);
                        }, 500);
                    }
                });
            }
            
            // Category filter change
            if (categoryFilter) {
                categoryFilter.addEventListener('change', (e) => {
                    const isCards = e.target.value === 'cards';
                    if (tcgFilterContainer) tcgFilterContainer.style.display = isCards ? 'block' : 'none';
                    if (priceFilterContainer) priceFilterContainer.style.display = isCards ? 'block' : 'none';
                    
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                });
            }
            
            // TCG filter change
            if (tcgFilter) {
                tcgFilter.addEventListener('change', () => {
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                });
            }
            
            // Pagination event listeners
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        performSearch(currentQuery, currentPage - 1);
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    performSearch(currentQuery, currentPage + 1);
                });
            }

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    performSearch(currentQuery, currentPage + 1, true);
                });
            }
            
            // Clear filters
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    if (categoryFilter) categoryFilter.value = 'cards';
                    if (tcgFilter) tcgFilter.value = 'mtg';
                    document.getElementById('price-min').value = '';
                    document.getElementById('price-max').value = '';
                    
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                });
            }
            
            console.log('Search functionality ready!');
            
            // Initialize with URL parameter if present
            const params = new URLSearchParams(window.location.search);
            const initialQuery = params.get('query');
            if (initialQuery) {
                performSearch(initialQuery);
            }
        });
    </script>

    <!-- Sidebar Toggle Logic -->
    <script>
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
        }
    </script>
</body>
</html>
