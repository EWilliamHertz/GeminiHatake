<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - HatakeSocial</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-64 bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out fixed lg:relative z-30 h-full" id="sidebar">
            <div class="p-6">
                <div class="flex items-center space-x-3 mb-8">
                    <img src="images/logo.png" alt="HatakeSocial Logo" class="w-10 h-10 rounded-full">
                    <h1 class="text-xl font-bold">HatakeSocial</h1>
                </div>
                <ul class="space-y-2">
                    <li><a href="index.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-home text-blue-500"></i><span>Feed</span><span class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full">2</span></a></li>
                    <li><a href="messages.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-envelope text-yellow-500"></i><span>Messages</span><span class="ml-auto bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">3</span></a></li>
                    <li><a href="community.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-users text-purple-500"></i><span>Community</span><span class="ml-auto bg-purple-500 text-white text-xs px-2 py-1 rounded-full">4</span></a></li>
                    <li><a href="articles.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-newspaper text-teal-500"></i><span>TCG Articles</span><span class="ml-auto bg-teal-500 text-white text-xs px-2 py-1 rounded-full">8</span></a></li>
                    <li><a href="blog.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-blog text-pink-500"></i><span>Hatake Blog</span><span class="ml-auto bg-pink-500 text-white text-xs px-2 py-1 rounded-full">3</span></a></li>
                    <li><a href="events.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-calendar text-purple-500"></i><span>Events</span><span class="ml-auto bg-purple-500 text-white text-xs px-2 py-1 rounded-full">7</span></a></li>
                    <li><a href="my_collection.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-layer-group text-orange-500"></i><span>My Collection</span><span class="ml-auto bg-orange-500 text-white text-xs px-2 py-1 rounded-full">1</span></a></li>
                    <li><a href="deck_builder.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-hammer text-green-500"></i><span>Deck Builder</span><span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full">6</span></a></li>
                    <li><a href="shop.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-shopping-cart text-red-500"></i><span>Shop</span><span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">10</span></a></li>
                    <li><a href="marketplace.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-store text-blue-500"></i><span>Marketplace</span><span class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full">16</span></a></li>
                    <li><a href="trades.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-exchange-alt text-red-500"></i><span>Trades</span><span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">15</span></a></li>
                    <li><a href="profile.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-user text-green-500"></i><span>Profile</span><span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full">13</span></a></li>
                    <li><a href="settings.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-cog text-blue-500"></i><span>Settings</span><span class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full">14</span></a></li>
                    <li><a href="about.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-info-circle text-yellow-500"></i><span>About Us</span><span class="ml-auto bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">15</span></a></li>
                </ul>
            </div>
        </nav>

        <!-- Overlay for mobile sidebar -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden hidden" id="sidebar-overlay"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col lg:ml-0">
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 shadow-sm p-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button class="lg:hidden text-gray-600 dark:text-gray-300" id="sidebar-toggle">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <a href="index.html" class="text-xl font-bold text-blue-600 dark:text-blue-400">HatakeSocial</a>
                </div>
                <div class="flex-1 max-w-2xl mx-4">
                    <div class="relative">
                        <input type="text" 
                               placeholder="Search for cards, users, or articles..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                               id="main-search-bar">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex items-center space-x-5" id="user-actions">
                    <!-- This container is dynamically filled by auth.js -->
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="container mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <!-- Filters Sidebar -->
                        <aside class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md h-fit sticky top-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold">Filters</h2>
                                <button class="text-sm text-blue-600 dark:text-blue-400 hover:underline" id="clear-filters">Clear All</button>
                            </div>
                            
                            <!-- Category Filter -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                                <select class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" id="filter-category">
                                    <option value="cards" selected>Cards</option>
                                    <option value="users">Users</option>
                                    <option value="articles">Articles</option>
                                </select>
                            </div>

                            <!-- TCG Selection -->
                            <div class="mb-6" id="tcg-filter-container">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Trading Card Game</label>
                                <select class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="filter-tcg">
                                    <option value="mtg" selected>Magic: The Gathering</option>
                                    <option value="pokemon">Pokémon</option>
                                    <option value="lorcana">Lorcana</option>
                                    <option value="gundam">Gundam</option>
                                </select>
                            </div>

                            <!-- Price Range Filter -->
                            <div class="mb-6" id="price-filter-container">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price Range (USD)</label>
                                <div class="flex space-x-2">
                                    <input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="price-min" min="0" placeholder="Min" step="0.01" type="number"/>
                                    <input class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" id="price-max" min="0" placeholder="Max" step="0.01" type="number"/>
                                </div>
                            </div>
                        </aside>

                        <!-- Results Area -->
                        <div class="lg:col-span-3">
                            <!-- Search Header -->
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                                <h1 class="text-3xl font-bold mb-4 sm:mb-0">
                                    Search Results for "<span id="search-query-display"></span>"
                                </h1>
                                <!-- Sort Controls -->
                                <div class="flex items-center space-x-4">
                                    <select class="appearance-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="sort-select">
                                        <option value="relevance">Relevance</option>
                                        <option value="name-asc">Name A-Z</option>
                                        <option value="name-desc">Name Z-A</option>
                                        <option value="price-asc">Price Low to High</option>
                                        <option value="price-desc">Price High to Low</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Loading Indicator -->
                            <div class="hidden text-center p-8" id="loading-indicator">
                                <div class="inline-flex items-center">
                                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mr-4"></i>
                                    <div>
                                        <p class="text-lg font-medium">Searching...</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Finding the best results for you</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Search Results -->
                            <div class="space-y-8" id="search-results-area">
                                <p class="text-center text-gray-500 dark:text-gray-400 text-lg">Please enter a search term in the bar above.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="js/darkmode.js"></script>
    <script src="js/auth.js"></script>

    <!-- Search Functionality -->
    <script>
        console.log('Search page loading...');
        
        // Wait for Firebase to be ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready, initializing search...');
            
            // DOM Elements
            const headerSearchBar = document.getElementById('main-search-bar');
            const resultsArea = document.getElementById('search-results-area');
            const loadingIndicator = document.getElementById('loading-indicator');
            const searchQueryDisplay = document.getElementById('search-query-display');
            const tcgFilter = document.getElementById('filter-tcg');
            const categoryFilter = document.getElementById('filter-category');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const tcgFilterContainer = document.getElementById('tcg-filter-container');
            const priceFilterContainer = document.getElementById('price-filter-container');
            
            let currentQuery = '';
            let searchTimeout = null;
            
            // Search functions for different APIs
            const searchMTG = async (query) => {
                console.log('Searching MTG for:', query);
                const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&unique=prints`);
                if (!response.ok) {
                    if (response.status === 404) return [];
                    throw new Error(`MTG API Error: ${response.status}`);
                }
                const data = await response.json();
                return data.data || [];
            };
            
            const searchPokemon = async (query) => {
                console.log('Searching Pokemon for:', query);
                const response = await fetch(`https://api.pokemontcg.io/v2/cards?q=name:${encodeURIComponent(query)}`, {
                    headers: { 'X-Api-Key': '60a08d4a-3a34-43d8-8f41-827b58cfac6d' }
                });
                if (!response.ok) {
                    throw new Error(`Pokemon API Error: ${response.status}`);
                }
                const data = await response.json();
                return data.data || [];
            };
            
            const searchScryDex = async (query, game) => {
                console.log(`Searching ScryDex for ${game}:`, query);
                try {
                    const searchScryDexFunction = firebase.functions().httpsCallable('searchScryDex');
                    const result = await searchScryDexFunction({ cardName: query, game: game });
                    
                    if (result && result.data && Array.isArray(result.data.data)) {
                        return result.data.data;
                    } else if (result && Array.isArray(result.data)) {
                        return result.data;
                    }
                    return [];
                } catch (error) {
                    console.error(`ScryDex search error for ${game}:`, error);
                    return [];
                }
            };
            
            // Main search function
            const searchCards = async (query, tcg) => {
                console.log(`Searching for "${query}" in ${tcg}`);
                
                if (!query || query.trim().length < 2) {
                    throw new Error('Search query must be at least 2 characters long.');
                }

                try {
                    switch (tcg) {
                        case 'mtg':
                            return await searchMTG(query);
                        case 'pokemon':
                            return await searchPokemon(query);
                        case 'lorcana':
                            return await searchScryDex(query, 'lorcana');
                        case 'gundam':
                            return await searchScryDex(query, 'gundam');
                        default:
                            return await searchMTG(query);
                    }
                } catch (error) {
                    console.error(`Search failed for ${tcg}:`, error);
                    throw error;
                }
            };
            
            // Render card function
            const renderCard = (card, tcg) => {
                const name = card.name || 'Unknown Card';
                let imageUrl = 'https://via.placeholder.com/200x280?text=No+Image';
                let price = 'N/A';
                let setName = 'Unknown Set';
                
                // Handle different card data structures
                if (tcg === 'mtg') {
                    imageUrl = card.image_uris?.normal || card.image_uris?.small || imageUrl;
                    price = card.prices?.usd ? `$${parseFloat(card.prices.usd).toFixed(2)}` : 
                           card.prices?.eur ? `€${parseFloat(card.prices.eur).toFixed(2)}` : 'N/A';
                    setName = card.set_name || 'Unknown Set';
                } else if (tcg === 'pokemon') {
                    imageUrl = card.images?.small || card.images?.large || imageUrl;
                    if (card.cardmarket && card.cardmarket.prices && card.cardmarket.prices.averageSellPrice) {
                        price = `€${parseFloat(card.cardmarket.prices.averageSellPrice).toFixed(2)}`;
                    } else if (card.tcgplayer && card.tcgplayer.prices && card.tcgplayer.prices.normal && card.tcgplayer.prices.normal.market) {
                        price = `$${parseFloat(card.tcgplayer.prices.normal.market).toFixed(2)}`;
                    }
                    setName = card.set?.name || 'Unknown Set';
                } else {
                    // ScryDex data (Lorcana, Gundam)
                    imageUrl = card.image || card.image_url || imageUrl;
                    if (card.price) {
                        price = `$${parseFloat(card.price).toFixed(2)}`;
                    }
                    setName = card.set || card.expansion || 'Unknown Set';
                }
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer" 
                         onclick="openCardDetails('${name.replace(/'/g, "\\'")}', '${tcg}')">
                        <div class="aspect-w-3 aspect-h-4 bg-gray-200 dark:bg-gray-700">
                            <img src="${imageUrl}" alt="${name}" class="w-full h-48 object-cover" 
                                 onerror="this.src='https://via.placeholder.com/200x280?text=No+Image'">
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white truncate">${name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">${setName}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-green-600 dark:text-green-400">${price}</span>
                                <button class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                                        onclick="event.stopPropagation(); addCardToCollection('${name.replace(/'/g, "\\'")}', '${tcg}')">
                                    Add to Collection
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // Perform search function
            const performSearch = async (query) => {
                if (!query || query.trim().length < 2) {
                    resultsArea.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 text-lg">Please enter a search term.</p>';
                    return;
                }
                
                currentQuery = query;
                if (headerSearchBar) headerSearchBar.value = query;
                if (searchQueryDisplay) searchQueryDisplay.textContent = query;
                
                // Show loading
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                resultsArea.innerHTML = '';
                
                try {
                    const selectedCategory = categoryFilter ? categoryFilter.value : 'cards';
                    
                    if (selectedCategory === 'cards') {
                        const selectedTcg = tcgFilter ? tcgFilter.value : 'mtg';
                        const results = await searchCards(query, selectedTcg);
                        
                        if (results.length === 0) {
                            resultsArea.innerHTML = `
                                <div class="text-center p-8">
                                    <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">No Results Found</h3>
                                    <p class="text-gray-600 dark:text-gray-400">Try adjusting your search terms or selecting a different TCG.</p>
                                </div>
                            `;
                        } else {
                            const cardElements = results.slice(0, 20).map(card => renderCard(card, selectedTcg)).join('');
                            resultsArea.innerHTML = `
                                <div class="mb-4">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${query}" in ${tcgFilter.options[tcgFilter.selectedIndex].text} (showing first 20)
                                    </p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    ${cardElements}
                                </div>
                            `;
                        }
                    } else {
                        // Handle users and articles search later
                        resultsArea.innerHTML = `
                            <div class="text-center p-8">
                                <i class="fas fa-info-circle text-4xl text-blue-400 mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Feature Coming Soon</h3>
                                <p class="text-gray-600 dark:text-gray-400">${selectedCategory} search will be available soon. For now, please search for cards.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    resultsArea.innerHTML = `
                        <div class="text-center p-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Search Error</h3>
                            <p class="text-gray-600 dark:text-gray-400">An error occurred while searching: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    if (loadingIndicator) loadingIndicator.classList.add('hidden');
                }
            };
            
            // Global functions
            window.performSearch = performSearch;
            
            window.openCardDetails = (cardName, tcg) => {
                console.log('Opening card details for:', cardName, 'from', tcg);
                alert(`Card details for ${cardName} (${tcg}) - Feature coming soon!`);
            };
            
            window.addCardToCollection = (cardName, tcg) => {
                console.log('Adding card to collection:', cardName, 'from', tcg);
                alert(`Added ${cardName} (${tcg}) to collection - Feature coming soon!`);
            };
            
            // Event listeners
            if (headerSearchBar) {
                headerSearchBar.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearch(headerSearchBar.value);
                    }
                });
                
                // Debounced search as user types
                headerSearchBar.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    if (e.target.value.length >= 2) {
                        searchTimeout = setTimeout(() => {
                            performSearch(e.target.value);
                        }, 500);
                    }
                });
            }
            
            // Category filter change
            if (categoryFilter) {
                categoryFilter.addEventListener('change', (e) => {
                    const isCards = e.target.value === 'cards';
                    if (tcgFilterContainer) tcgFilterContainer.style.display = isCards ? 'block' : 'none';
                    if (priceFilterContainer) priceFilterContainer.style.display = isCards ? 'block' : 'none';
                    
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                });
            }
            
            // TCG filter change
            if (tcgFilter) {
                tcgFilter.addEventListener('change', () => {
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                });
            }
            
            // Clear filters
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    if (categoryFilter) categoryFilter.value = 'cards';
                    if (tcgFilter) tcgFilter.value = 'mtg';
                    document.getElementById('price-min').value = '';
                    document.getElementById('price-max').value = '';
                    
                    if (currentQuery) {
                        performSearch(currentQuery);
                    }
                });
            }
            
            console.log('Search functionality ready!');
            
            // Initialize with URL parameter if present
            const params = new URLSearchParams(window.location.search);
            const initialQuery = params.get('query');
            if (initialQuery) {
                performSearch(initialQuery);
            }
        });
    </script>

    <!-- Sidebar Toggle Logic -->
    <script>
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
        }
    </script>
</body>
</html>
